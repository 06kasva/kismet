<html>
<head>
<title>Kismet</title>

<script src="/js/msgpack.js"></script>
<script src="/js/jquery-2.2.0.min.js"></script>
<script src="/js/jquery.ajax.binary.js"></script>
<script src="/js/kismet.utils.js"></script>
<script src="/js/kismet.ui.js"></script>
<script src="/js/jquery.dataTables.min.js"></script>
<script src="/js/dataTables.scroller.min.js"></script>
<script src="/js/jquery.sparkline.min.js"></script>
<script src="/js/d3.v3.min.js" charset="utf-8"></script>

<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="css/reset.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/text.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/grid.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/layout.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/nav.css" media="screen" />
<!--[if IE 6]><link rel="stylesheet" type="text/css" href="css/ie6.css" media="screen" /><![endif]-->
<!--[if IE 7]><link rel="stylesheet" type="text/css" href="css/ie.css" media="screen" /><![endif]-->
<link rel="stylesheet" href="/css/jquery.dataTables.min.css"/>

<script>

var packetGraphWidth = 120;
var packetGraphHeight = 20;

var deviceTid;

function populateDeviceSummary() {
    $("#live").empty();
    kismet.GetDeviceSummary(function(devices) {
        for (var x = 0; x < devices.length; x++ ) {
            var d = devices[x];

            var newDiv = document.createElement("div");
            $(newDiv).append(d["kismet.device.base.name"]);
            $(newDiv).append("<b>[ Graph packets ]</b>");
            $(newDiv).attr("key", d["kismet.device.base.key"]);
            $(newDiv).click(function () { populateDeviceGraph($(this).attr("key")); });

            $("#live").append(newDiv);
        }
    }, function(e) {
        $("#live").append("Couldn't fetch list " + e);    
    });

}

/* Last update we got from the device delta, we use it for some of the
   graphing updates later on too */
var last_devicelist_time = 0

function handleDeviceSummary() {

    var dt = $('#devices').DataTable();

    // Preserve the scroll position
    scrollPos = $(".dataTables_scrollBody").scrollTop();

    $.get("/devices/last-time/" + last_devicelist_time + "/devices.json")
        .done(function(data) {

        last_devicelist_time = data.kismet_devicelist_timestamp;

        for (var d in data.kismet_device_list) {
            var dev = data.kismet_device_list[d];
            var row = dt.row("#" + dev.kismet_device_base_key);

            if (typeof(row.data()) !== 'undefined') {
                row.data(dev);
                row.invalidate();
            } else {
                dt.row.add(dev);
            }
        }

        if (data.kismet_devicelist_refresh == 1) {
            dt.ajax.reload(function() {
                $(".dataTables_scrollBody").scrollTop(scrollPos);
            },false);
        } else {
            dt.draw(false);
            // $(".dataTables_scrollBody").scrollTop(scrollPos);
        }
    });

    /* Bulk-refresh the whole table, not what we
    $('#devices').DataTable().ajax.reload(function() {
        $(".dataTables_scrollBody").scrollTop(scrollPos);
    },false);
    */


    deviceTid = setTimeout(handleDeviceSummary, 2000); 
}

var svg = d3.select("#foobar");

$(document).ready(function() {
    kismet_ui.BatteryUi($("#batspinner"), $("#batpower"), $("#battime"));

    $('#devices').DataTable( {
        "scrollY":        "60vh",
        "scroller":       true,
        // "scrollCollapse": true,
        // "stateSave":      true,
        "ajax":           "/devices/all_devices_dt.json",
        "deferRender":    true,
        aoColumns: [
        { sTitle: "Name", mData: "kismet_device_base_name" },
        { sTitle: "Type", mData: "kismet_device_base_type" },
        { sTitle: "Phy", mData: "kismet_device_base_phyname" },
        { sTitle: "Signal", mData: "kismet_device_base_signal.kismet_common_signal_last_signal_dbm" },
        { sTitle: "Channel", mData: "kismet_device_base_channel" },
        { sTitle: "Last Time", mData: "kismet_device_base_last_time", name: "last_time",
            "render": function(data, type, row, meta) {
                return new Date(data * 1000);
            }
        },
        { sTitle: "Packets", mData: null, defaultContent: "", name: "packets" },
        ], 
        "order":
            [ [ 0, "desc" ] ],

        rowId: "kismet_device_base_key",

        "drawCallback": function( settings ) {
            var page = this.DataTable().scroller.page();

            // Find the column
            var rid = this.DataTable().column('packets:name').index();
            var match = "td:eq(" + rid + ")";

            // For the rows that are visible...
            for (var r = page.start; r < page.end; r++) {
                // Grab the data
                var row = this.DataTable().row(r);
                var data = row.data();

                // Get the key
                var key = data["kismet_device_base_key"]

                // Simplify the RRD so that the bars are thicker in the graph, which
                // I think looks better
                var avg = 0;
                var secs_avg = 3;

                var simple_rrd = [];
                var rrd_len = data["kismet_device_base_packets_rrd"]["kismet_common_rrd_minute_vec"].length;
                var startsec = data["kismet_device_base_packets_rrd"]["kismet_common_rrd_last_time"];
                var startslot = data["kismet_device_base_packets_rrd"]["kismet_common_rrd_last_time"] % 60;

                if (last_devicelist_time - startsec > 60) {
                    // If we haven't seen this device in more than a minute the
                    // graph is no good, fill it with zeroes in the most annoying
                    // way possible to make sure that we match the number of empty bars
                    for (var ri = 0; ri < rrd_len; ri += 1) {
                        if ((ri % secs_avg) == (secs_avg - 1))
                            simple_rrd.push(0);
                    }
                } else {
                    for (var ri = 0; ri < rrd_len; ri++) {
                        avg += data["kismet_device_base_packets_rrd"]["kismet_common_rrd_minute_vec"][(startslot + ri) % rrd_len];

                        if ((ri % secs_avg) == (secs_avg - 1)) {
                            simple_rrd.push(Math.round(avg / secs_avg));
                            avg = 0;
                        }
                    }
                }

                $(match, row.node()).sparkline(simple_rrd, 
                        { type: "bar",
                          barColor: '#000000' });

            }

        }

    });

    handleDeviceSummary();
});

</script>

</head>
<body>

    <div class="container_16">
        <div class="grid_16">
            <div class="box">
                <h2>Kismet</h2>
                <div style="text-align: right;"><span id="battime">00:11:22</span> <a href="#"><img id="batpower" src="/img/icon_battery_0.svg" style="width: 2em; height: auto; align: right; vertical-align: middle;"></a></div>
                <i id="batspinner" class="fa fa-refresh fa-spin"></i>
            </div>
        </div>

        <div class="clear"></div>

        <div class="grid_16">
            <div class="box">
                <h2>Devices</h2>

                <div id="devtable" class="fill">
                    <table id="devices" class="hover" cellspacing="0" width="100%">
                    </table>
                </div>

            </div>
        </div>

        <div class="clear"></div>

        <div class="grid_16" id="site_info">
            <div class="box">
                <p>Powered by many open source JS components, look at the <a href="/credit.html">credits page</a>
            </div>
        </div>
    </div>

</body>
</html>
