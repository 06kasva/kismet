<html>
<head>
<title>Kismet</title>

<script src="/js/msgpack.js"></script>
<script src="/js/jquery-2.2.0.min.js"></script>
<script src="/js/jquery.ajax.binary.js"></script>
<script src="/js/kismet.utils.js"></script>
<script src="/js/jquery.dataTables.min.js"</script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="css/reset.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/text.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/grid.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/layout.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/nav.css" media="screen" />
<!--[if IE 6]><link rel="stylesheet" type="text/css" href="css/ie6.css" media="screen" /><![endif]-->
<!--[if IE 7]><link rel="stylesheet" type="text/css" href="css/ie.css" media="screen" /><![endif]-->

<script>

var batteryTid;
var deviceTid;

function updateBatteryUi() {
    $("#batspinner").show();
    kismetGetSystemStatus(function(status) {
        if (status['kismet.system.battery.charging'] == "charging") {
            $("#batpower").attr("src", "/img/icon_battery_full_charge.svg");
            $("#battime").text("Charging " + 
                    status['kismet.system.battery.percentage'] + "% ");
        } else if (status['kismet.system.battery.charging'] == "charged") {
            $("#batpower").attr("src", "/img/icon_battery_full_charge.svg");
            $("#battime").text("Charged");
        } else {
            if (status['kismet.system.battery.percentage'] < 25)
                $("#batpower").attr("src", "/img/icon_battery_0.svg");
            else if (status['kismet.system.battery.percentage'] < 50)
                $("#batpower").attr("src", "/img/icon_battery_25.svg");
            else if (status['kismet.system.battery.percentage'] < 75)
                $("#batpower").attr("src", "/img/icon_battery_50.svg");
            else if (status['kismet.system.battery.percentage'] < 90)
                $("#batpower").attr("src", "/img/icon_battery_75.svg");
            else 
                $("#batpower").attr("src", "/img/icon_battery_100.svg");

            var s = status['kismet.system.battery.remaining'];

            if (s > 0) {
                var h = Math.floor(s / 3600);
                s -= 3600 * h;
                var m = Math.floor(s / 60);
                s -= 60 * m;

                if (m < 10)
                    m = '0' + m
                
                $("#battime").text(status['kismet.system.battery.percentage'] + "% " + h+"h "+m+"m");
            } else {
                $("#battime").text(status['kismet.system.battery.percentage'] + "%")
            }
        }

    }, function() {
        $("#batpower").attr("src", "/img/icon/battery_no_battery_power.svg");
        $("#battime").text("ERROR");
    });
    $("#batspinner").hide();

    batteryTid = setTimeout(updateBatteryUi, 5000); // repeat myself
}

function populateDeviceGraph(key) {
    kismetGetDevice(key, function(d) {
        console.log(d["kismet.device.base.name"]);

        var packets = d["kismet.device.base.packets.rrd"]["kismet.common.rrd.minute_vec"];
        var lineData = [];

        for (var i = 0; i < packets.length; i++) {
            var pdata = {x: i, y: packets[i]}
            lineData.push(pdata);
        }

        $("#visualization").attr("key", key);
        $("#visualization").click(function() {
            populateDeviceGraph($(this).attr("key"));
        });

var vis = d3.select("#visualisation"),
    WIDTH = 500,
    HEIGHT = 100,
    MARGINS = {
      top: 20,
      right: 20,
      bottom: 20,
      left: 50
    },
    xRange = d3.scale.linear().range([MARGINS.left, WIDTH - MARGINS.right]).domain([d3.min(lineData, function (d) {
        return d.x;
      }),
      d3.max(lineData, function (d) {
        return d.x;
      })
    ]),

    yRange = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([d3.min(lineData, function (d) {
        return d.y;
      }),
      d3.max(lineData, function (d) {
        return d.y;
      })
    ]),

    xAxis = d3.svg.axis()
      .scale(xRange)
      .tickSize(5)
      .tickSubdivide(true),

    yAxis = d3.svg.axis()
      .scale(yRange)
      .tickSize(5)
      .orient("left")
      .tickSubdivide(true);


  vis.append("svg:g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")
    .call(xAxis);

  vis.append("svg:g")
    .attr("class", "y axis")
    .attr("transform", "translate(" + (MARGINS.left) + ",0)")
    .call(yAxis);

  var lineFunc = d3.svg.line()
  .x(function (d) {
    return xRange(d.x);
  })
  .y(function (d) {
    return yRange(d.y);
  })
  .interpolate('linear');

vis.selectAll("svg > *").remove();
vis.append("svg:path")
  .attr("d", lineFunc(lineData))
  .attr("stroke", "blue")
  .attr("stroke-width", 2)
  .attr("fill", "none");

    graphId = key;
    if (graphTid -= 0)
        graphTid = setTimeout(function() { populateDeviceGraph(graphId)}, 1000); 

    }, function(e) {
        alert("fetch failed for " + key + " " + e);
    });
}

function populateDeviceSummary() {
    $("#live").empty();
    kismetGetDeviceSummary(function(devices) {
        for (var x = 0; x < devices.length; x++ ) {
            var d = devices[x];

            var newDiv = document.createElement("div");
            $(newDiv).append(d["kismet.device.base.name"]);
            $(newDiv).append("<b>[ Graph packets ]</b>");
            $(newDiv).attr("key", d["kismet.device.base.key"]);
            $(newDiv).click(function () { populateDeviceGraph($(this).attr("key")); });

            $("#live").append(newDiv);
        }
    }, function(e) {
        $("#live").append("Couldn't fetch list " + e);    
    });

}

function handleDeviceSummary() {
    kismetGetDeviceSummary(function(devices) {
        var conv = [];

        for (var x = 0; x < devices.length; x++) {
            var d = devices[x];
            var t = new Date(d["kismet.device.base.last_time"]*1000);
            var cd = [
                d["kismet.device.base.name"],
                d["kismet.device.base.type"],
                d["kismet.device.base.phyname"],
                d["kismet.device.base.signal"]["kismet.common.signal.last_signal_dbm"],
                t
            ];

            conv.push(cd);
        }


        var dt = $('#devices').dataTable().api();

        var scrollPos = $(".dataTables_scrollBody").scrollTop();

        dt.clear();
        dt.rows.add(conv);
        dt.draw();

        $(".dataTables_scrollBody").scrollTop(scrollPos);

    }, function(e) {
        alert(e);
    });

    deviceTid = setTimeout(handleDeviceSummary, 2000); 
}

$(document).ready(function() {
    updateBatteryUi();

    $('#devices').DataTable( {
        "scrollY":        "45em",
        "scrollCollapse": true,
        "paging":         false,
        columns: [
        { title: "Name" },
        { title: "Type" },
        { title: "Phy" },
        { title: "Signal" },
        { title: "Last Time" },
        ]
    });

    handleDeviceSummary();
});

</script>

</head>
<body>

    <div class="container_16">
        <div class="box">
            <h2>Kismet</h2>
            <div style="text-align: right;"><span id="battime">00:11:22</span> <a href="#"><img id="batpower" src="/img/icon_battery_0.svg" style="width: 2em; height: auto; align: right; vertical-align: middle;"></a></div>
            <i id="batspinner" class="fa fa-refresh fa-spin"></i>
        </div>
    </div>

    <div class="clear"></div>

    <div class="container_16">
        <div class="box">
            <h2>Devices</h2>

            <table id="devices" class="display" cellspacing="0" width="100%">
            </table>

        </div>
    </div>
</body>
</html>
