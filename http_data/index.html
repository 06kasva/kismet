<html>
<head>
<title>Kismet</title>

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="/js/msgpack.js"></script>
<script src="/js/jquery-3.1.0.min.js"></script>
<script src="/js/jquery.ajax.binary.js"></script>
<script src="/js/kismet.utils.js"></script>
<script src="/js/kismet.ui.js"></script>
<script src="/js/jquery.dataTables.min.js"></script>
<script src="/js/dataTables.scroller.min.js"></script>
<script src="/js/jquery.sparkline.min.js"></script>
<script src="/js/jquery-ui.min.js"></script>
<script src="/js/jquery.jspanel-compiled.min.js"></script>

<script src="/js/jquery.kismet.devicedata.js"></script>

<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="css/reset.css" />
<link rel="stylesheet" type="text/css" href="css/text.css" />
<link rel="stylesheet" type="text/css" href="css/grid.css" />
<link rel="stylesheet" type="text/css" href="css/layout.css" />
<link rel="stylesheet" type="text/css" href="css/nav.css" />
<!--[if IE 6]><link rel="stylesheet" type="text/css" href="css/ie6.css" media="screen" /><![endif]-->
<!--[if IE 7]><link rel="stylesheet" type="text/css" href="css/ie.css" media="screen" /><![endif]-->
<link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css" />
<link rel="stylesheet" type="text/css" href="css/jquery.jspanel.min.css" />
<link rel="stylesheet" type="text/css" href="/css/jquery.dataTables.min.css"/>

<style type="text/css">
td.highlight {
    /* background-color: whitesmoke !important; */
    background-color: #dddddd !important;
}

div.autosize {
    height: auto !important;
    min-height: 10px;
}

table.kismet_devicedata {
    border: 0;
}

</style>

<script>

var deviceTid;

/* Last update we got from the device delta, we use it for some of the
   graphing updates later on too */
var last_devicelist_time = 0

function handleDeviceSummary() {

    var dt = $('#devices').DataTable();

    // Preserve the scroll position
    scrollPos = $(".dataTables_scrollBody").scrollTop();

    $.get("/devices/last-time/" + last_devicelist_time + "/devices.json")
        .done(function(data) {

        last_devicelist_time = data.kismet_devicelist_timestamp;

        for (var d in data.kismet_device_list) {
            var dev = data.kismet_device_list[d];
            var row = dt.row("#" + dev.kismet_device_base_key);

            if (typeof(row.data()) !== 'undefined') {
                row.data(dev);
                row.invalidate();
            } else {
                dt.row.add(dev);
            }
        }

        if (data.kismet_devicelist_refresh == 1) {
            dt.ajax.reload(function() {
                $(".dataTables_scrollBody").scrollTop(scrollPos);
            },false);
        } else {
            dt.draw(false);
            // $(".dataTables_scrollBody").scrollTop(scrollPos);
        }
    });

    /* Bulk-refresh the whole table, not what we
    $('#devices').DataTable().ajax.reload(function() {
        $(".dataTables_scrollBody").scrollTop(scrollPos);
    },false);
    */


    deviceTid = setTimeout(handleDeviceSummary, 2000);
}

$(function() {
    kismet_ui.BatteryUi($("#batspinner"), $("#batpower"), $("#battime"));

    $('#devices').DataTable( {
        "scrollY":        "60vh",
        "scroller":       true,
        // "scrollCollapse": true,
        // "stateSave":      true,
        "ajax":           "/devices/all_devices_dt.json",
        "deferRender":    true,
        aoColumns: [
        { sTitle: "Name", mData: "kismet_device_base_name" },
        { sTitle: "Type", mData: "kismet_device_base_type" },
        { sTitle: "Phy", mData: "kismet_device_base_phyname" },
        { sTitle: "Signal", mData: "kismet_device_base_signal.kismet_common_signal_last_signal_dbm" },
        { sTitle: "Channel", mData: "kismet_device_base_channel" },
        { sTitle: "Last Time", mData: "kismet_device_base_last_time", name: "last_time",
            "render": function(data, type, row, meta) {
                return new Date(data * 1000).toString().substring(4, 25);
            }
        },
        { sTitle: "Packets", mData: null, defaultContent: "", name: "packets",
            "render": function(data, type, row, meta) {
                return "<i>Preparing graph</i>";
            }},
        ],
        "order":
            [ [ 0, "desc" ] ],

        rowId: "kismet_device_base_key",

        "drawCallback": function( settings ) {
            $(this.api().table().container())
                .find('div.dataTables_paginate')
                .css( 'display', 'none' );
            $(this.api().table().container())
                .find('div.dataTables_length')
                .css( 'display', 'none' );

            var page = this.DataTable().scroller.page();

            // Find the column
            var rid = this.DataTable().column('packets:name').index();
            var match = "td:eq(" + rid + ")";

            // Kluge the visible rows because it seems to miss the first and last
            // with some degree of regularity
            if (page.start > 0)
                page.start--;
            page.end++;

            for (var r = page.start; r < page.end; r++) {
                // Grab the data
                // var row = this.DataTable().row(r);
                var row = this.DataTable().row(':eq('+r+')', {order:'applied', search:'applied'});
                var data = row.data();

                // Simplify the RRD so that the bars are thicker in the graph, which
                // I think looks better
                var avg = 0;
                var secs_avg = 3;

                var simple_rrd = [];
                var rrd_len = data["kismet_device_base_packets_rrd"]["kismet_common_rrd_minute_vec"].length;
                var startsec = data["kismet_device_base_packets_rrd"]["kismet_common_rrd_last_time"];
                var startslot = data["kismet_device_base_packets_rrd"]["kismet_common_rrd_last_time"] % 60;

                if (last_devicelist_time - startsec > 60) {
                    for (var ri = 0; ri < (rrd_len / secs_avg); ri++) {
                        simple_rrd.push(0);
                    }
                } else {
                    /* Skip ahead by the number of seconds since the last time */
                    var sec_offt = Math.max(0, last_devicelist_time - startsec);

                    // Clobber some seconds
                    for (var ri = 0; ri < sec_offt; ri++) {
                         data["kismet_device_base_packets_rrd"]["kismet_common_rrd_minute_vec"][(startslot + ri) % rrd_len] = 0;
                    }

                    // And advance the start
                    startslot = (startslot + sec_offt) % 60;

                    for (var ri = 0; ri < rrd_len; ri++) {
                        avg += data["kismet_device_base_packets_rrd"]["kismet_common_rrd_minute_vec"][(startslot + ri) % rrd_len];

                        if ((ri % secs_avg) == (secs_avg - 1)) {
                            simple_rrd.push(Math.round(avg / secs_avg));
                            avg = 0;
                        }
                    }
                }

                $(match, row.node()).sparkline(simple_rrd,
                        { type: "bar",
                          barColor: '#000000',
                          nullColor: '#000000',
                          zeroColor: '#000000'
                          });

            }

        }

    });

    var device_dt = $('#devices').DataTable();

    // Set an onclick handler
    $('#devices tbody').on('click', 'tr', function () {
        // Fetch the data of the row that got clicked
        var data = device_dt.row( this ).data();

        // Generate a unique ID for this dialog
        var dialogid = "devicedialog" + data["kismet_device_base_key"];
        var dialogmatch = '#' + dialogid;

        var w = ($(window).width() / 3) - 20;

        if (w < 500) {
            w = ($(window).width() / 2) - 20;
        }

        $.jsPanel({
            id: dialogid,
            headerTitle: data["kismet_device_base_name"],
            position: {
                "my": "left-top",
                "at": "left-top",
                "of": "window",
                "offsetX": 5,
                "offsetY": 10,
                "autoposition": "RIGHT"
            },

            contentSize: {
                "width": w,
                "height": $(window).height() * 0.9
            },

            callback: function() {
                // Append an accordion div
                this.content.append($('<div />',
                        {"id": "accordion"}));

                // Match using our parent dialog ID or we over-modify
                $(dialogmatch + ' #accordion')
                    .append($('<h3 />', {
                        "id": "device",
                        "html": "Device Info"
                    }));

                $(dialogmatch + ' #accordion #device')
                    .after($('<div />', {
                        "id": "devicedata",
                        "class": "autosize",
                    }));

                $.get("/devices/by-key/" + data.kismet_device_base_key + "/device.json")
                    .done(function(fulldata) {
                        $(dialogmatch + ' #devicedata').devicedata(fulldata, {
                            "id": "genericDeviceData",
                            "fields": [
                                {
                                    field: "kismet_device_base_name",
                                    title: "Name",
                                    empty: "<i>None</i>"
                                },
                                {
                                    field: "kismet_device_base_macaddr",
                                    title: "MAC Address",
                                    render: function(key, data, value) {
                                        // Split out the mac from the mask
                                        return value.split('/')[0];
                                    }
                                },
                                {
                                    field: "kismet_device_base_type",
                                    title: "Type",
                                    empty: "Unknown"
                                },
                                {
                                    field: "kismet_device_base_first_time",
                                    title: "First Seen",
                                    render: function(key, data, value) {
                                        return new Date(value * 1000);
                                    }
                                },
                                {
                                    field: "kismet_device_base_last_time",
                                    title: "Last Seen",
                                    render: function(key, data, value) {
                                        return new Date(value * 1000);
                                    }
                                },
                                {
                                    field: "group_signal_data",
                                    groupTitle: "Signal",
                                    id: "group_signal_data",

                                    fields: [
                                    { // Only show when dbm
                                        field: "kismet_device_base_signal.kismet_common_signal_last_signal_dbm",
                                        title: "Latest Signal",
                                        render: function(key, data, value) {
                                            return value + " dBm";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Only show when rssi
                                        field: "kismet_device_base_signal.kismet_common_signal_last_signal_rssi",
                                        title: "Latest Signal",
                                        render: function(key, data, value) {
                                            return value + " RSSI";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Only show when dbm
                                        field: "kismet_device_base_signal.kismet_common_signal_last_noise_dbm",
                                        title: "Latest Noise",
                                        render: function(key, data, value) {
                                            return value + " dBm";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Only show when rssi
                                        field: "kismet_device_base_signal.kismet_common_signal_last_noise_rssi",
                                        title: "Latest Noise",
                                        render: function(key, data, value) {
                                            return value + " RSSI";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Only show when dbm
                                        field: "kismet_device_base_signal.kismet_common_signal_min_signal_dbm",
                                        title: "Min. Signal",
                                        render: function(key, data, value) {
                                            return value + " dBm";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Only show when rssi
                                        field: "kismet_device_base_signal.kismet_common_signal_min_signal_rssi",
                                        title: "Min. Signal",
                                        render: function(key, data, value) {
                                            return value + " RSSI";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Only show when dbm
                                        field: "kismet_device_base_signal.kismet_common_signal_max_signal_dbm",
                                        title: "Max. Signal",
                                        render: function(key, data, value) {
                                            return value + " dBm";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Only show when rssi
                                        field: "kismet_device_base_signal.kismet_common_signal_max_signal_rssi",
                                        title: "Max. Signal",
                                        render: function(key, data, value) {
                                            return value + " RSSI";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Only show when dbm
                                        field: "kismet_device_base_signal.kismet_common_signal_min_noise_dbm",
                                        title: "Min. Noise",
                                        render: function(key, data, value) {
                                            return value + " dBm";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Only show when rssi
                                        field: "kismet_device_base_signal.kismet_common_signal_min_noise_rssi",
                                        title: "Min. Noise",
                                        render: function(key, data, value) {
                                            return value + " RSSI";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Only show when dbm
                                        field: "kismet_device_base_signal.kismet_common_signal_max_noise_dbm",
                                        title: "Max. Noise",
                                        render: function(key, data, value) {
                                            return value + " dBm";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Only show when rssi
                                        field: "kismet_device_base_signal.kismet_common_signal_max_noise_rssi",
                                        title: "Max. Noise",
                                        render: function(key, data, value) {
                                            return value + " RSSI";
                                        },
                                        filter: function(key, data, value) {
                                            return (value != 0);
                                        }
                                    },
                                    { // Pseudo-field of aggregated location, only show when the location is valid
                                        field: "kismet_device_base_signal.kismet_common_signal_peak_loc",
                                        title: "Peak Location",
                                        filter: function(key, data, value) {
                                            return kismet.ObjectByString(data, "kismet_device_base_signal.kismet_common_signal_peak_loc.kismet_common_location_valid") == 1;
                                        },
                                        render: function(key, data, value) {
                                            var loc = 
                                                kismet.ObjectByString(data, "kismet_device_base_signal.kismet_common_signal_peak_loc.kismet_common_location_lat") + ", " + 
                                                kismet.ObjectByString(data, "kismet_device_base_signal.kismet_common_signal_peak_loc.kismet_common_location_lon");

                                            /*
                                            if (kismet.ObjectByString(data, "kismet_device_base_signal.kismet_common_signal_peak_loc.kismet_common_location_fix") >= 3) {
                                                loc += " " + kismet.ObjectByString(data, "kismet_device_base_signal.kismet_common_signal_peak_loc.kismet_common_location_alt") + " (M)";
                                            }
                                            */

                                            return loc;
                                        },
                                    },

                                    ],
                                },
                                {
                                    field: "group_packet_counts",
                                    groupTitle: "Packets",
                                    id: "group_packet_counts",

                                    fields: [
                                    {
                                        field: "kismet_device_base_packets_total",
                                        title: "Total Packets"
                                    },
                                    {
                                        field: "kismet_device_base_packets_llc",
                                        title: "LLC/Management"
                                    },
                                    {
                                        field: "kismet_device_base_packets_error",
                                        title: "Error/Invalid"
                                    },
                                    {
                                        field: "kismet_device_base_packets_data",
                                        title: "Data"
                                    },
                                    {
                                        field: "kismet_device_base_packets_crypt",
                                        title: "Encrypted"
                                    },
                                    {
                                        field: "kismet_device_base_packets_filtered",
                                        title: "Filtered"
                                    },
                                    {
                                        field: "kismet_device_base_datasize",
                                        title: "Data Transferred",
                                        render: function(key, data, value) {
                                            return kismet.HumanReadableSize(value);
                                        }
                                    }


                                    ]
                                },

                                {
                                    // Sub-group, groups it in a control group 
                                    // spanning both columns
                                    groupTitle: "Avg. Location",
                                    // Spoofed field for ID purposes
                                    field: "group_avg_location",
                                    // Sub-table ID
                                    id: "group_avg_location",

                                    // Don't show location if we don't know it
                                    filter: function(key, data, value) {
                                        return (kismet.ObjectByString(data, "kismet_device_base_location.kismet_common_location_avg_loc.kismet_common_location_valid") == 1);
                                    },

                                    // Fields in subgroup
                                    fields: [
                                    { 
                                        field: "kismet_device_base_location.kismet_common_location_avg_loc.kismet_common_location_lat",
                                        title: "Latitude"
                                    },
                                    {
                                        field: "kismet_device_base_location.kismet_common_location_avg_loc.kismet_common_location_lon",
                                        title: "Longitude"
                                    },
                                    {
                                        field: "kismet_device_base_location.kismet_common_location_avg_loc.kismet_common_location_alt",
                                        title: "Altitude (meters)",
                                        filter: function(key, data, value) {
                                            return (kismet.ObjectByString(data, "kismet_device_base_location.kismet_common_location_avg_loc.kismet_common_location_fix") >= 3);
                                        }

                                    }
                                    ],
                                }
                            ]
                        });

                    });

                $(dialogmatch + ' #accordion')
                    .append($('<h3 />', {
                        "id": "dot11", "html": "802.11 Info"
                    }));

                $(dialogmatch + ' #accordion #dot11')
                    .after($('<p />', {
                        "html": "802.11 info table"
                    }));

                $(dialogmatch + ' #accordion').accordion();
            }

        })
    } );

    // Start the auto-updating
    handleDeviceSummary();

    $('#devices tbody')
        .on( 'mouseenter', 'td', function () {
            var colIdx = device_dt.cell(this).index().column;
            var rowIdx = device_dt.cell(this).index().row;

            // Remove from all cells
            $( device_dt.cells().nodes() ).removeClass( 'highlight' );
            // Highlight the td in this row
            $( 'td', device_dt.row(rowIdx).nodes() ).addClass('highlight');
        } );

});
</script>

</head>
<body>
    <div class="container_16">
        <div class="grid_16">
            <div class="box">
                <h2>Kismet</h2>
                <div style="text-align: right;"><span id="battime">00:11:22</span> <a href="#"><img id="batpower" src="/images/icon_battery_0.svg" style="width: 2em; height: auto; align: right; vertical-align: middle;"></a></div>
                <i id="batspinner" class="fa fa-refresh fa-spin"></i>
            </div>
        </div>

        <div class="clear"></div>

        <div class="grid_16">
            <div class="box">
                <h2>Devices</h2>

                <div id="devtable" class="fill">
                    <table id="devices" class="stripe hover" cell-spacing="0" width="100%">
                    </table>
                </div>

            </div>
        </div>

        <div class="clear"></div>

        <div class="grid_16" id="site_info">
            <div class="box">
                <p>Powered by many open source JS components, look at the <a href="/credit.html">credits page</a>
            </div>
        </div>
    </div>

</body>
</html>
