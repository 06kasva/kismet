<html>
<head>
<title>Kismet</title>

<script src="/js/msgpack.js"></script>
<script src="/js/jquery-2.2.0.min.js"></script>
<script src="/js/jquery.ajax.binary.js"></script>
<script src="/js/kismet.utils.js"></script>
<script src="/js/jquery.dataTables.min.js"></script>
<script src="/js/d3.v3.min.js" charset="utf-8"></script>

<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="css/reset.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/text.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/grid.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/layout.css" media="screen" />
<link rel="stylesheet" type="text/css" href="css/nav.css" media="screen" />
<!--[if IE 6]><link rel="stylesheet" type="text/css" href="css/ie6.css" media="screen" /><![endif]-->
<!--[if IE 7]><link rel="stylesheet" type="text/css" href="css/ie.css" media="screen" /><![endif]-->
<link rel="stylesheet" href="/css/jquery.dataTables.min.css"/>

<script>

var batteryTid;
var deviceTid;

function updateBatteryUi() {
    $("#batspinner").show();
    kismet.GetSystemStatus(function(status) {
        if (status['kismet.system.battery.charging'] == "charging") {
            $("#batpower").attr("src", "/img/icon_battery_full_charge.svg");
            $("#battime").text("Charging " + 
                    status['kismet.system.battery.percentage'] + "% ");
        } else if (status['kismet.system.battery.charging'] == "charged") {
            $("#batpower").attr("src", "/img/icon_battery_full_charge.svg");
            $("#battime").text("Charged");
        } else {
            if (status['kismet.system.battery.percentage'] < 25)
                $("#batpower").attr("src", "/img/icon_battery_0.svg");
            else if (status['kismet.system.battery.percentage'] < 50)
                $("#batpower").attr("src", "/img/icon_battery_25.svg");
            else if (status['kismet.system.battery.percentage'] < 75)
                $("#batpower").attr("src", "/img/icon_battery_50.svg");
            else if (status['kismet.system.battery.percentage'] < 90)
                $("#batpower").attr("src", "/img/icon_battery_75.svg");
            else 
                $("#batpower").attr("src", "/img/icon_battery_100.svg");

            var s = status['kismet.system.battery.remaining'];

            if (s > 0) {
                var h = Math.floor(s / 3600);
                s -= 3600 * h;
                var m = Math.floor(s / 60);
                s -= 60 * m;

                if (m < 10)
                    m = '0' + m
                
                $("#battime").text(status['kismet.system.battery.percentage'] + "% " + h+"h "+m+"m");
            } else {
                $("#battime").text(status['kismet.system.battery.percentage'] + "%")
            }
        }

    }, function() {
        $("#batpower").attr("src", "/img/icon/battery_no_battery_power.svg");
        $("#battime").text("ERROR");
    });
    $("#batspinner").hide();

    batteryTid = setTimeout(updateBatteryUi, 5000); // repeat myself
}

function populateDeviceSummary() {
    $("#live").empty();
    kismet.GetDeviceSummary(function(devices) {
        for (var x = 0; x < devices.length; x++ ) {
            var d = devices[x];

            var newDiv = document.createElement("div");
            $(newDiv).append(d["kismet.device.base.name"]);
            $(newDiv).append("<b>[ Graph packets ]</b>");
            $(newDiv).attr("key", d["kismet.device.base.key"]);
            $(newDiv).click(function () { populateDeviceGraph($(this).attr("key")); });

            $("#live").append(newDiv);
        }
    }, function(e) {
        $("#live").append("Couldn't fetch list " + e);    
    });

}

function handleDeviceSummary() {
    kismet.GetDeviceSummary(function(devices) {
        var conv = [];

        for (var x = 0; x < devices.length; x++) {
            var d = devices[x];
            var t = new Date(d["kismet.device.base.last_time"]*1000);

            var cd = {
                key: d["kismet.device.base.key"],
                name: d["kismet.device.base.name"],
                type: d["kismet.device.base.type"],
                phyname: d["kismet.device.base.phyname"],
                signal: d["kismet.device.base.signal"]["kismet.common.signal.last_signal_dbm"],
                time: t,
                channel: d["kismet.device.base.channel"],
                rrdsecond: d["kismet.device.base.packets.rrd"]["kismet.common.rrd.last_time"],
                rrddata: d["kismet.device.base.packets.rrd"]["kismet.common.rrd.minute_vec"],
            };

            conv.push(cd);
        }

        var dt = $('#devices').dataTable().api();

        var scrollPos = $(".dataTables_scrollBody").scrollTop();

        dt.clear();
        dt.rows.add(conv);
        dt.draw();

        $(".dataTables_scrollBody").scrollTop(scrollPos);

        var w = 120;
        var h = 20;
        var barPadding = 0;

        for (var i = 0; i < conv.length; i++) {
            var rrd = [ ];
            var starts = conv[i]['rrdsecond'] % 60;
            var rrdlen = conv[i]['rrddata'].length;

            // start at the current second in the rrd, and average them
            // to thicker bars.
            var avg = 0;
            var secs_avg = 3;
            for (var r = 0; r < rrdlen; r++) {
                avg += conv[i]['rrddata'][(starts + r) % rrdlen];

                if ((r % secs_avg) == (secs_avg - 1)) {
                    rrd.push(avg / secs_avg);
                    avg = 0;
                }

                // rrd.push(conv[i]['rrddata'][(starts + r) % rrdlen])
            }

            var svg = d3.select("#graphContainer" + conv[i]['key'])
                .append("svg")
                .attr("width", w)
                .attr("height", h);

            svg.selectAll("rect")
                .data(rrd)
                .enter()
                .append("rect")
                .attr("x", function(d, i) {
                    return i * (w / rrd.length);
                })
                .attr("y", function(d) {
                    return h - (d * 4);
                })
                .attr("width", w / rrd.length - barPadding)
                .attr("height", function(d) {
                    return d * 4;
                });

        }

    }, function(e) {
        throw(e);
    });

    deviceTid = setTimeout(handleDeviceSummary, 2000); 
}

var svg = d3.select("#foobar");

$(document).ready(function() {
    updateBatteryUi();

    $('#devices').DataTable( {
        "scrollY":        "60vh",
        "scrollCollapse": true,
        "paging":         false,
        columns: [
        { title: "Name", data: "name" },
        { title: "Type", data: "type" },
        { title: "Phy", data: "phyname" },
        { title: "Signal", data: "signal" },
        { title: "Channel", data: "channel" },
        { title: "Last Time", data: "time" },
        { title: "Packets", data: null, defaultContent: "" },
        ],
        "order":
            [ [ 0, "desc" ] ],
        "fnRowCallback": function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
            // Set an ID on the row for us to go in after and set the graph with D3
            var row = $('td:eq(6)', nRow).attr("id", "graphContainer" + aData['key']);
            return nRow;
        }
    });

    handleDeviceSummary();
});

</script>

</head>
<body>

    <div class="container_16">
        <div class="grid_16">
            <div class="box">
                <h2>Kismet</h2>
                <div style="text-align: right;"><span id="battime">00:11:22</span> <a href="#"><img id="batpower" src="/img/icon_battery_0.svg" style="width: 2em; height: auto; align: right; vertical-align: middle;"></a></div>
                <i id="batspinner" class="fa fa-refresh fa-spin"></i>
            </div>
        </div>

        <div class="clear"></div>

        <div class="grid_16">
            <div class="box">
                <h2>Devices</h2>

                <div id="devtable" class="fill">
                    <table id="devices" class="hover" cellspacing="0" width="100%">
                    </table>
                </div>

            </div>
        </div>

        <div class="clear"></div>

        <div class="grid_16" id="site_info">
            <div class="box">
                <p>Powered by many open source JS components, look at the <a href="/credit.html">credits page</a>
            </div>
        </div>
    </div>

</body>
</html>
